<!-- Deployment v3 -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collaborative Word Grid Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            overflow-x: hidden;
        }
        .die {
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .die.selected {
            transform: scale(0.9) rotate(5deg);
            background-color: #fbbf24; /* amber-400 */
            color: #1f2937; /* gray-800 */
        }
        .modal-bg {
            background-color: rgba(0, 0, 0, 0.2); /* Reduced dimness */
            transition: opacity 0.3s ease;
        }
        .panel {
            transition: opacity 0.5s ease, transform 0.5s ease, width 0.5s ease;
        }
        .panel-hidden {
            opacity: 0;
            transform: scale(0.95);
            pointer-events: none;
            width: 0 !important;
            padding: 0 !important;
            margin: 0 !important;
        }
        .word-list-item:hover {
            background-color: #e5e7eb;
        }
        .modal {
            position: fixed;
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            overflow: hidden; /* Important for resizing */
        }
        .modal-header {
            cursor: move;
            background-color: #f9fafb; /* gray-50 */
            border-bottom: 1px solid #e5e7eb; /* gray-200 */
        }
        .resize-handle {
            position: absolute;
            width: 16px;
            height: 16px;
            right: 0;
            bottom: 0;
            cursor: nwse-resize;
            background-image: linear-gradient(135deg, transparent 0%, transparent 50%, #6b7280 50%, #6b7280 100%);
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex items-center justify-center min-h-screen">

    <div id="app-container" class="w-full max-w-7xl mx-auto p-4 flex flex-row gap-6 justify-center">
        <!-- Lobby View -->
        <div id="lobby-view" class="w-full flex flex-col md:flex-row gap-6 justify-center">
            <!-- Create Game Panel -->
            <div id="create-game-panel" class="w-full md:w-1/2 bg-white p-6 rounded-2xl shadow-lg flex flex-col gap-4">
                 <h2 class="text-2xl font-bold text-gray-700">Create Game</h2>
                 <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="timer-setting" class="font-semibold text-gray-600">Time (s):</label>
                        <input type="number" id="timer-setting" value="120" min="30" max="300" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label for="min-word-length" class="font-semibold text-gray-600">Min Length:</label>
                        <input type="number" id="min-word-length" value="3" min="2" max="10" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    </div>
                </div>
                 <div>
                    <label for="grid-size" class="font-semibold text-gray-600">Grid Size:</label>
                    <select id="grid-size" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        <option value="3">3x3</option>
                        <option value="4">4x4</option>
                        <option value="5" selected>5x5</option>
                        <option value="6">6x6</option>
                        <option value="7">7x7</option>
                    </select>
                </div>
                 <div>
                    <label class="font-semibold text-gray-600">Word Filters:</label>
                    <div class="flex flex-wrap gap-2 my-2" id="filter-tags-container"></div>
                    <div class="flex gap-2">
                        <input type="text" id="filter-input" placeholder="Add custom filter (e.g. adjective)" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        <button id="add-filter-btn" class="bg-indigo-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-600">+</button>
                    </div>
                </div>
                <button id="create-game-btn" class="w-full bg-green-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-600 transition-colors duration-300 shadow-md mt-auto">Create New Game</button>
            </div>
            <div class="w-full md:w-1/2 bg-white p-6 rounded-2xl shadow-lg flex flex-col gap-4">
                 <h2 class="text-2xl font-bold text-gray-700">Join Game</h2>
                 <p class="text-gray-600">Ask a friend for their Game ID to join their room.</p>
                 <div class="flex gap-2 mt-auto">
                     <input type="text" id="join-game-id-input" placeholder="Enter Game ID" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 transition">
                     <button id="join-game-btn" class="bg-gray-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-700 transition-colors duration-300 shadow-md">Join</button>
                 </div>
            </div>
        </div>

        <!-- Game View -->
        <div id="game-view" class="w-full flex-row gap-6 hidden">
            <div id="left-panel" class="panel lg:w-1/4 bg-white p-6 rounded-2xl shadow-lg flex-col gap-6 order-2 lg:order-1 h-fit flex">
                <div id="game-info-controls"></div>
                <div id="leaderboard-summary" class="cursor-pointer">
                    <h2 class="text-2xl font-bold text-gray-700 mb-4 hover:text-indigo-600">Leaderboard ðŸ”Ž</h2>
                    <div id="leaderboard" class="space-y-2"></div>
                </div>
                 <div>
                    <h3 class="text-xl font-bold text-gray-700 mb-2">My User ID</h3>
                     <p id="user-id-display" class="text-xs text-gray-500 break-all"></p>
                </div>
            </div>

            <div id="center-panel" class="flex-grow bg-white p-6 rounded-2xl shadow-lg order-1 lg:order-2 flex flex-col items-center justify-center">
                 <div class="w-full flex items-center justify-between mb-4">
                    <div>
                         <button id="show-panels-btn" class="hidden bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">Show Info</button>
                    </div>
                    <div class="text-center">
                        <div id="timer-display" class="text-6xl font-bold text-indigo-600">00:00</div>
                        <div id="game-status-display" class="text-lg text-gray-500 mt-1"></div>
                    </div>
                    <div class="w-28"></div>
                </div>
                <div id="game-grid" class="grid gap-2 aspect-square w-full max-w-lg"></div>
            </div>

            <div id="right-panel" class="panel lg:w-1/4 bg-white p-6 rounded-2xl shadow-lg flex-col gap-4 order-3 h-fit flex">
                 <div>
                    <h2 class="text-2xl font-bold text-gray-700 mb-4">Current Word</h2>
                    <div id="current-word-display" class="w-full h-16 bg-gray-100 rounded-lg flex items-center justify-center text-3xl font-semibold tracking-widest border-2 border-dashed"></div>
                    <div class="flex gap-2 mt-4">
                        <button id="submit-word-btn" class="flex-grow bg-yellow-500 text-white font-bold py-3 px-4 rounded-lg">Submit</button>
                        <button id="clear-word-btn" class="bg-red-500 text-white font-bold py-3 px-4 rounded-lg">Clear</button>
                    </div>
                </div>
                <div>
                    <h2 class="text-2xl font-bold text-gray-700 mb-4">My Words</h2>
                    <ul id="my-words-list" class="h-64 overflow-y-auto bg-gray-50 p-3 rounded-lg border"></ul>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="scoring-modal" class="modal hidden" style="width: 800px; height: 600px; top: 15%; left: 25%; z-index: 50;">
        <div id="scoring-modal-header" class="modal-header p-4 flex justify-between items-center"><h2 class="text-2xl font-bold text-center flex-grow">Round Over!</h2><button id="close-scoring-modal-btn" class="text-2xl font-bold">&times;</button></div>
        <div id="scoring-modal-content" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 p-6 overflow-y-auto h-[calc(100%-60px)]"></div>
        <div class="resize-handle"></div>
    </div>
    <div id="standings-modal" class="modal hidden" style="width: 900px; height: 700px; top: 10%; left: 20%; z-index: 50;">
        <div id="standings-modal-header" class="modal-header p-4 flex justify-between items-center"><h2 class="text-2xl font-bold">Standings & History</h2><button id="close-standings-modal-btn" class="text-2xl font-bold">&times;</button></div>
        <div id="standings-modal-content" class="p-6 overflow-y-auto h-[calc(100%-60px)]"></div>
        <div class="resize-handle"></div>
    </div>
    <div id="dictionary-modal" class="modal hidden" style="width: 450px; height: 500px; top: 20%; left: 35%; z-index: 60;">
        <div id="dictionary-modal-header" class="modal-header p-4 flex justify-between items-center"><h2 id="dictionary-word" class="text-2xl font-bold">Word</h2><button id="close-dictionary-btn" class="text-2xl font-bold">&times;</button></div>
        <div id="dictionary-definition" class="p-6 text-sm text-gray-700 overflow-y-auto h-[calc(100%-60px)]"></div>
        <div class="resize-handle"></div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyD_CHO-e69XJJh8NoD6fm4ih1YryuRCWeY",
          authDomain: "word-grid-game-live.firebaseapp.com",
          projectId: "word-grid-game-live",
          storageBucket: "word-grid-game-live.firebasestorage.app",
          messagingSenderId: "216890772517",
          appId: "1:216890772517:web:71d2d55f4adf295db043cc"
        };
        const appId = 'word-game';
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        const DICE = ['A','A','E','E','G','N', 'A','B','B','J','O','O', 'A','C','H','O','P','S', 'A','F','F','K','P','S','A','O','O','T','T','W', 'C','I','M','O','T','U', 'D','E','I','L','R','X', 'D','E','L','R','V','Y','D','I','S','T','T','Y', 'E','E','G','H','N','W', 'E','E','I','N','S','U', 'E','H','R','T','V','W','E','I','O','S','S','T', 'E','L','R','T','T','Y', 'H','I','M','N','U','Q', 'H','L','N','N','R','Z'];
        let userId = null, gameId = null, gameData = {}, playerWords = {}, currentWord = [], gameUnsubscribe = null, wordsUnsubscribe = {}, timerInterval = null;
        let highestZ = 60;

        const el = {
            lobbyView: document.getElementById('lobby-view'), gameView: document.getElementById('game-view'), leftPanel: document.getElementById('left-panel'),
            rightPanel: document.getElementById('right-panel'), createGameBtn: document.getElementById('create-game-btn'), joinGameBtn: document.getElementById('join-game-btn'),
            joinGameIdInput: document.getElementById('join-game-id-input'), gameInfoControls: document.getElementById('game-info-controls'), timerSetting: document.getElementById('timer-setting'),
            minWordLength: document.getElementById('min-word-length'), gridSize: document.getElementById('grid-size'), filterInput: document.getElementById('filter-input'),
            addFilterBtn: document.getElementById('add-filter-btn'), filterTagsContainer: document.getElementById('filter-tags-container'),
            leaderboard: document.getElementById('leaderboard'), leaderboardSummary: document.getElementById('leaderboard-summary'), userIdDisplay: document.getElementById('user-id-display'),
            timerDisplay: document.getElementById('timer-display'), gameStatusDisplay: document.getElementById('game-status-display'), gameGrid: document.getElementById('game-grid'),
            currentWordDisplay: document.getElementById('current-word-display'), submitWordBtn: document.getElementById('submit-word-btn'), clearWordBtn: document.getElementById('clear-word-btn'),
            myWordsList: document.getElementById('my-words-list'), scoringModal: document.getElementById('scoring-modal'),
            scoringModalContent: document.getElementById('scoring-modal-content'), closeScoringModalBtn: document.getElementById('close-scoring-modal-btn'),
            dictionaryModal: document.getElementById('dictionary-modal'), dictionaryWord: document.getElementById('dictionary-word'),
            dictionaryDefinition: document.getElementById('dictionary-definition'), closeDictionaryBtn: document.getElementById('close-dictionary-btn'),
            showPanelsBtn: document.getElementById('show-panels-btn'), standingsModal: document.getElementById('standings-modal'),
            standingsModalContent: document.getElementById('standings-modal-content'), closeStandingsModalBtn: document.getElementById('close-standings-modal-btn'),
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) { userId = user.uid; el.userIdDisplay.textContent = userId; } 
            else { try { if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token); else await signInAnonymously(auth); } catch(error) { console.error("Sign-In Error:", error); }}
        });
        
        el.createGameBtn.addEventListener('click', handleCreateGame);
        el.joinGameBtn.addEventListener('click', handleJoinGame);
        el.submitWordBtn.addEventListener('click', handleSubmitWord);
        el.clearWordBtn.addEventListener('click', clearCurrentWord);
        el.closeScoringModalBtn.addEventListener('click', () => el.scoringModal.classList.add('hidden'));
        el.closeDictionaryBtn.addEventListener('click', hideDefinition);
        el.addFilterBtn.addEventListener('click', addFilterTag);
        el.filterInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') addFilterTag(); });
        el.showPanelsBtn.addEventListener('click', togglePanels);
        el.leaderboardSummary.addEventListener('click', showStandingsModal);
        el.closeStandingsModalBtn.addEventListener('click', () => el.standingsModal.classList.add('hidden'));
        window.addEventListener('keydown', handleKeyDown);
        
        // Setup all modals
        setupModal(el.scoringModal);
        setupModal(el.standingsModal);
        setupModal(el.dictionaryModal);
        
        function createFilterTag(text) { const tag = document.createElement('div'); tag.className = "flex items-center bg-indigo-100 text-indigo-700 text-sm font-semibold px-3 py-1 rounded-full"; tag.textContent = text; const removeBtn = document.createElement('button'); removeBtn.className = "ml-2 text-indigo-500 hover:text-indigo-700 font-bold"; removeBtn.innerHTML = '&times;'; removeBtn.onclick = () => tag.remove(); tag.appendChild(removeBtn); el.filterTagsContainer.appendChild(tag); }
        function addFilterTag() { const text = el.filterInput.value.trim().toLowerCase(); if (text) { createFilterTag(text); el.filterInput.value = ''; }}
        ['noun', 'verb', 'no plurals'].forEach(createFilterTag);

        async function handleCreateGame() {
            if (!userId) return;
            const newGameId = crypto.randomUUID().split('-')[0];
            const gameRef = doc(db, `artifacts/${appId}/public/data/games`, newGameId);
            const playerInfo = { name: `Player ${userId.substring(0, 4)}`, score: 0, roundScore: 0, history: {} };
            const filters = Array.from(el.filterTagsContainer.children).map(tag => tag.firstChild.textContent.trim());
            try { await setDoc(gameRef, { createdAt: new Date(), hostId: userId, status: 'waiting', timerDuration: parseInt(el.timerSetting.value, 10), minWordLength: parseInt(el.minWordLength.value, 10), gridSize: parseInt(el.gridSize.value, 10), wordFilters: filters, grid: '[]', players: { [userId]: playerInfo }, round: 0 }); await joinGame(newGameId); } catch (error) { console.error("Error creating game:", error); }
        }
        
        function handleJoinGame() { const gameIdToJoin = el.joinGameIdInput.value.trim(); if (gameIdToJoin) joinGame(gameIdToJoin); }

        async function joinGame(id) {
            if (!userId) return;
            if (gameUnsubscribe) gameUnsubscribe();
            Object.values(wordsUnsubscribe).forEach(unsub => unsub());
            wordsUnsubscribe = {}; gameId = id;
            const gameRef = doc(db, `artifacts/${appId}/public/data/games`, gameId);
            try {
                const gameSnap = await getDoc(gameRef);
                if (!gameSnap.exists()) { alert("Game not found!"); return; }
                const game = gameSnap.data();
                if (!game.players[userId]) { const playerInfo = { name: `Player ${userId.substring(0, 4)}`, score: 0, roundScore: 0, history: {} }; await updateDoc(gameRef, { [`players.${userId}`]: playerInfo }); }
                el.lobbyView.classList.add('hidden'); el.gameView.classList.remove('hidden'); el.gameView.classList.add('flex');
                gameUnsubscribe = onSnapshot(gameRef, (doc) => { gameData = doc.data(); if (gameData) { renderGame(); listenForPlayerWords(); }});
            } catch (error) { console.error("Error joining game:", error); }
        }
        
        async function handleStartGame() {
            if (!gameId || gameData.hostId !== userId) return;
            const currentRound = (gameData.round || 0) + 1;
            const size = gameData.gridSize;
            const shuffledDice = DICE.sort(() => 0.5 - Math.random());
            const newGrid = Array.from({ length: size }, (_, r) => Array.from({ length: size }, (_, c) => shuffledDice[(r * size + c) % shuffledDice.length]));
            const updatedPlayers = { ...gameData.players };
            Object.keys(updatedPlayers).forEach(pid => { updatedPlayers[pid].roundScore = 0; });
            const batch = writeBatch(db);
            Object.keys(gameData.players).forEach(pid => { const wordsRef = doc(db, `artifacts/${appId}/public/data/games/${gameId}/playerWords`, pid); batch.set(wordsRef, { [currentRound]: [] }, { merge: true }); });
            await batch.commit();
            await updateDoc(doc(db, `artifacts/${appId}/public/data/games`, gameId), { status: 'playing', grid: JSON.stringify(newGrid), round: currentRound, players: updatedPlayers, timer: gameData.timerDuration });
        }
        
        async function handleRestartGame() { if (!gameId || gameData.hostId !== userId) return; location.reload(); }
        async function handlePauseResumeGame() { if (!gameId || gameData.hostId !== userId) return; const newStatus = gameData.status === 'playing' ? 'paused' : 'playing'; await updateDoc(doc(db, `artifacts/${appId}/public/data/games`, gameId), { status: newStatus });}
        
        async function handleSubmitWord() {
            const word = currentWord.map(w => w.letter).join('').toUpperCase();
            if (word.length < gameData.minWordLength) { alert(`Word must be at least ${gameData.minWordLength} letters long.`); return; }
            const myCurrentWords = playerWords[userId]?.[gameData.round] || [];
            if (myCurrentWords.includes(word)) { alert("You have already submitted this word."); clearCurrentWord(); return; }
            try { const wordsRef = doc(db, `artifacts/${appId}/public/data/games/${gameId}/playerWords`, userId); await setDoc(wordsRef, { [gameData.round]: [...myCurrentWords, word] }, { merge: true }); clearCurrentWord(); } catch(error) { console.error("Error submitting word:", error); }
        }
        
        function handleDieClick(dieEl, letter, row, col) { if (!dieEl || currentWord.some(d => d.row === row && d.col === col)) return; currentWord.push({ letter, row, col }); dieEl.classList.add('selected'); renderCurrentWord(); }
        
        async function validateWord(word, filters) {
            try {
                const response = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${word}`);
                if (!response.ok) return { isValid: false }; 
                const data = await response.json();
                const entry = data[0];
                if (!entry) return { isValid: false };
                let passesFilters = true;
                if (filters.includes('no plurals')) {
                    if (word.toLowerCase().endsWith('s') && entry.word.toLowerCase() !== word.toLowerCase()) {
                        const singularForm = word.slice(0, -1);
                        if (entry.word.toLowerCase() === singularForm.toLowerCase()) {
                           passesFilters = false;
                        }
                    }
                }
                const partsOfSpeech = new Set(entry.meanings.map(m => m.partOfSpeech));
                const posFilters = filters.filter(f => f !== 'no plurals');
                if (posFilters.length > 0 && !posFilters.some(f => partsOfSpeech.has(f))) {
                    passesFilters = false;
                }
                return { isValid: passesFilters };
            } catch (error) { return { isValid: false }; }
        }
        
        async function calculateScores() {
            if (userId !== gameData.hostId) return null;
            const allWordsDocs = await getDocs(collection(db, `artifacts/${appId}/public/data/games/${gameId}/playerWords`));
            const allPlayerWords = {};
            allWordsDocs.forEach(doc => { allPlayerWords[doc.id] = doc.data() || {}; });
            
            const currentRoundWordsByPlayer = {};
            Object.keys(allPlayerWords).forEach(pid => { currentRoundWordsByPlayer[pid] = allPlayerWords[pid][gameData.round] || []; });
            
            const isSinglePlayer = Object.keys(gameData.players).length === 1;
            let wordsToScore;
            if (isSinglePlayer) { wordsToScore = currentRoundWordsByPlayer[userId] || []; } 
            else { const allWordsList = Object.values(currentRoundWordsByPlayer).flat(); const wordCounts = allWordsList.reduce((acc, word) => { acc[word] = (acc[word] || 0) + 1; return acc; }, {}); wordsToScore = Object.keys(wordCounts).filter(word => wordCounts[word] === 1); }

            const validationPromises = wordsToScore.map(word => validateWord(word, gameData.wordFilters || []));
            const validationResults = await Promise.all(validationPromises);
            const validScoringWords = wordsToScore.filter((_, index) => validationResults[index].isValid);

            const updatedPlayers = { ...gameData.players };
            Object.keys(currentRoundWordsByPlayer).forEach(pid => {
                let roundScore = 0;
                currentRoundWordsByPlayer[pid].forEach(word => { if (validScoringWords.includes(word)) roundScore += word.length; });
                if (updatedPlayers[pid]) { updatedPlayers[pid].roundScore = roundScore; updatedPlayers[pid].score = (updatedPlayers[pid].score || 0) + roundScore; updatedPlayers[pid].history[gameData.round] = roundScore; }
            });
            await updateDoc(doc(db, `artifacts/${appId}/public/data/games`, gameId), { players: updatedPlayers });
            return { validWords: validScoringWords, allWords: allPlayerWords };
        }
        
        function renderGame() { renderLayout(); renderLeaderboard(); renderGameInfoControls(); renderTimerAndStatus(); renderGrid(); renderButtons(); }

        function renderLayout() { const isPlaying = gameData?.status === 'playing' || gameData?.status === 'paused'; el.leftPanel.classList.toggle('panel-hidden', isPlaying && !el.leftPanel.classList.contains('force-show')); el.rightPanel.classList.toggle('panel-hidden', false); el.showPanelsBtn.classList.toggle('hidden', !isPlaying); if (!isPlaying) el.leftPanel.classList.remove('force-show'); }
        function togglePanels() { el.leftPanel.classList.toggle('force-show'); renderLayout(); }
        function renderLeaderboard() { if (!gameData || !gameData.players) { el.leaderboard.innerHTML = '<p>No players yet.</p>'; return; } const playersArray = Object.entries(gameData.players).map(([id, data]) => ({ id, ...data })); playersArray.sort((a, b) => b.score - a.score); el.leaderboard.innerHTML = `<table class="w-full text-left"><thead><tr class="border-b-2"><th class="py-2 font-semibold">Player</th><th class="py-2 text-center">Round</th><th class="py-2 text-center">Total</th></tr></thead><tbody>${playersArray.map(p => `<tr class="border-b"><td class="py-2">${p.name} ${p.id === userId ? '(You)' : ''} ${p.isHost ? 'ðŸ‘‘' : ''}</td><td class="py-2 text-center">${p.roundScore}</td><td class="py-2 text-center font-bold">${p.score}</td></tr>`).join('')}</tbody></table>`; }
        function renderGameInfoControls() { if (!gameData) return; const isHost = userId === gameData.hostId; el.gameInfoControls.innerHTML = `<h2 class="text-2xl font-bold text-gray-700 mb-4">Game Info</h2><div><label class="font-semibold">Game ID:</label><div class="flex items-center gap-2 mt-1"><input id="game-id-display-ingame" type="text" readonly class="w-full bg-gray-100 px-3 py-2 border rounded-lg" value="${gameId}"><button id="copy-game-id-btn-ingame" class="bg-gray-200 p-2 rounded-lg"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z"></path><path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z"></path></svg></button></div></div>${isHost ? `<div id="host-controls" class="mt-4 space-y-2"><button id="start-next-round-btn-ingame" class="w-full bg-green-500 text-white font-bold py-2 px-4 rounded-lg"></button><button id="pause-resume-btn-ingame" class="w-full bg-orange-500 text-white font-bold py-2 px-4 rounded-lg"></button><button id="restart-game-btn-ingame" class="w-full bg-red-600 text-white font-bold py-2 px-4 rounded-lg">End & Restart Game</button></div>` : ''}`; if (isHost) { document.getElementById('start-next-round-btn-ingame')?.addEventListener('click', handleStartGame); document.getElementById('pause-resume-btn-ingame')?.addEventListener('click', handlePauseResumeGame); document.getElementById('restart-game-btn-ingame')?.addEventListener('click', handleRestartGame); } document.getElementById('copy-game-id-btn-ingame')?.addEventListener('click', () => handleCopyGameId(gameId));}
        
        async function renderTimerAndStatus() {
            if (!gameData) return;
            const { status, timer, round } = gameData;
            clearInterval(timerInterval);
            if (status === 'playing') {
                let timeLeft = timer;
                el.timerDisplay.textContent = formatTime(timeLeft); el.gameStatusDisplay.textContent = `Round ${round}`;
                if (userId === gameData.hostId) {
                    timerInterval = setInterval(async () => {
                        timeLeft--;
                        if (timeLeft >= 0) await updateDoc(doc(db, `artifacts/${appId}/public/data/games`, gameId), { timer: timeLeft });
                        else { clearInterval(timerInterval); await updateDoc(doc(db, `artifacts/${appId}/public/data/games`, gameId), { status: 'scoring' }); const scoreData = await calculateScores(); showScoringModal(scoreData); }
                    }, 1000);
                }
            } else if (status === 'paused') { el.timerDisplay.textContent = formatTime(timer); el.gameStatusDisplay.textContent = `Game Paused`; } 
            else if (status === 'scoring') { el.timerDisplay.textContent = '00:00'; el.gameStatusDisplay.textContent = `Round ${round} Over! Reviewing scores...`;} 
            else if (status === 'waiting') { el.timerDisplay.textContent = formatTime(gameData.timerDuration || 120); el.gameStatusDisplay.textContent = "Waiting for host..."; }
        }
        
        function renderGrid() {
            const { status, gridSize } = gameData; let grid;
            try { grid = typeof gameData.grid === 'string' ? JSON.parse(gameData.grid) : []; } catch (e) { grid = []; }
            el.gameGrid.innerHTML = ''; const size = gridSize || 5;
            el.gameGrid.style.gridTemplateColumns = `repeat(${size}, minmax(0, 1fr))`;
            if (!grid || grid.length === 0) { el.gameGrid.innerHTML = Array.from({length: size * size}).map(() => `<div class="aspect-square bg-gray-200 rounded-lg"></div>`).join(''); return; }
            grid.forEach((row, r) => { row.forEach((letter, c) => { const dieEl = document.createElement('button'); dieEl.className = 'die flex items-center justify-center text-2xl md:text-3xl font-bold uppercase bg-white rounded-lg cursor-pointer hover:bg-indigo-100'; dieEl.textContent = letter; dieEl.dataset.row = r; dieEl.dataset.col = c; if (status === 'playing') dieEl.onclick = () => handleDieClick(dieEl, letter, r, c); else { dieEl.disabled = true; dieEl.classList.add('cursor-not-allowed', 'opacity-70'); } el.gameGrid.appendChild(dieEl); }); });
        }
        
        function renderButtons() {
            if (!gameData || !gameData.players) return;
            const { status, hostId } = gameData;
            const isHost = userId === hostId;
            if (isHost && document.getElementById('host-controls')) {
                const startNextBtn = document.getElementById('start-next-round-btn-ingame');
                const pauseResumeBtn = document.getElementById('pause-resume-btn-ingame');
                const restartBtn = document.getElementById('restart-game-btn-ingame');
                if (startNextBtn) { startNextBtn.classList.toggle('hidden', status !== 'waiting' && status !== 'scoring'); startNextBtn.textContent = (gameData.round || 0) === 0 ? 'Start Game' : 'Start Next Round';}
                if(pauseResumeBtn) { const isPausable = (status === 'playing' || status === 'paused'); pauseResumeBtn.classList.toggle('hidden', !isPausable); if(isPausable) pauseResumeBtn.textContent = status === 'playing' ? 'Pause' : 'Resume'; }
                if(restartBtn) restartBtn.classList.toggle('hidden', status === 'playing' || status === 'paused');
            }
            const isPlaying = status === 'playing'; el.submitWordBtn.disabled = !isPlaying; el.clearWordBtn.disabled = !isPlaying;
        }

        function renderCurrentWord() { el.currentWordDisplay.textContent = currentWord.map(w => w.letter).join(''); }
        function renderMyWords() { const myWords = playerWords[userId]?.[gameData.round] || []; el.myWordsList.innerHTML = myWords.map(word => `<li class="p-2 bg-white rounded shadow-sm mb-2">${word}</li>`).join(''); el.myWordsList.scrollTop = el.myWordsList.scrollHeight; }
        
        async function showDefinition(word) {
            el.dictionaryWord.textContent = 'Loading...'; el.dictionaryDefinition.innerHTML = '';
            bringToFront(el.dictionaryModal);
            el.dictionaryModal.classList.remove('hidden');
            try {
                const response = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${word}`);
                el.dictionaryWord.textContent = word;
                if (!response.ok) { el.dictionaryDefinition.textContent = "No definition found."; return; }
                const data = await response.json();
                data[0].meanings.forEach(meaning => {
                    const partOfSpeech = document.createElement('strong');
                    partOfSpeech.className = "block mt-2 capitalize font-bold";
                    partOfSpeech.textContent = meaning.partOfSpeech;
                    el.dictionaryDefinition.appendChild(partOfSpeech);
                    const definitionsList = document.createElement('ul');
                    definitionsList.className = 'list-disc list-inside space-y-1';
                    meaning.definitions.forEach(def => { const li = document.createElement('li'); li.textContent = def.definition; definitionsList.appendChild(li); });
                    el.dictionaryDefinition.appendChild(definitionsList);
                });
            } catch (error) { el.dictionaryWord.textContent = word; el.dictionaryDefinition.textContent = "Error fetching definition."; }
        }
        
        function hideDefinition() { el.dictionaryModal.classList.add('hidden'); }

        async function showScoringModal({validWords, allWords}) {
            el.scoringModalContent.innerHTML = '';
            for (const pid in gameData.players) {
                const player = gameData.players[pid];
                const words = allWords[pid]?.[gameData.round] || [];
                const playerCard = document.createElement('div');
                playerCard.className = 'border rounded-lg p-4 bg-gray-50';
                playerCard.innerHTML = `<h3 class="font-bold text-xl mb-3">${player.name} - ${player.roundScore} pts</h3><ul class="space-y-1 h-48 overflow-y-auto pr-2"></ul>`;
                const wordListEl = playerCard.querySelector('ul');
                if (words.length === 0) { wordListEl.innerHTML = '<li class="text-gray-400">No words.</li>'; } 
                else {
                    words.forEach(word => {
                        const scoresWord = validWords.includes(word);
                        const points = scoresWord ? word.length : 0;
                        const li = document.createElement('li');
                        li.className = `flex justify-between items-center cursor-pointer p-1 rounded word-list-item`;
                        li.innerHTML = `<span>${word}</span><span class="${scoresWord ? 'font-semibold text-green-600' : 'text-gray-500 line-through'}">${scoresWord ? `+${points}`: '0'}</span>`;
                        li.addEventListener('click', () => showDefinition(word));
                        wordListEl.appendChild(li);
                    });
                }
                el.scoringModalContent.appendChild(playerCard);
            }
            bringToFront(el.scoringModal);
            el.scoringModal.classList.remove('hidden');
        }

        async function showStandingsModal() {
            const content = el.standingsModalContent;
            content.innerHTML = '';
            let table = `<table class="w-full text-left table-fixed"><thead class="bg-gray-100"><tr><th class="p-2 w-1/3">Player</th>`;
            const rounds = Array.from({length: gameData.round || 0}, (_, i) => i + 1);
            rounds.forEach(r => { table += `<th class="p-2 text-center cursor-pointer hover:bg-gray-200 round-history-btn" data-round="${r}">R${r}</th>`});
            table += `<th class="p-2 text-center">Total</th></tr></thead><tbody>`;
            const players = Object.values(gameData.players).sort((a, b) => b.score - a.score);
            players.forEach(p => {
                table += `<tr class="border-b"><td class="p-2 font-semibold">${p.name}</td>`;
                rounds.forEach(r => { table += `<td class="p-2 text-center">${p.history[r] || 0}</td>` });
                table += `<td class="p-2 text-center font-bold">${p.score}</td></tr>`;
            });
            table += `</tbody></table><div id="round-words-view" class="mt-4 p-2 bg-gray-50 rounded"></div>`;
            content.innerHTML = table;
            content.querySelectorAll('.round-history-btn').forEach(btn => btn.addEventListener('click', async (e) => {
                const roundNum = e.target.dataset.round;
                const wordView = document.getElementById('round-words-view');
                wordView.innerHTML = `<h3 class="text-xl font-bold mb-2">Words from Round ${roundNum}</h3>`;
                const allWordsDocs = await getDocs(collection(db, `artifacts/${appId}/public/data/games/${gameId}/playerWords`));
                const allWordsData = {};
                allWordsDocs.forEach(doc => { allWordsData[doc.id] = doc.data() || {}; });
                for(const pid in gameData.players) {
                    const pName = gameData.players[pid].name;
                    const words = allWordsData[pid]?.[roundNum] || [];
                    const playerWordsDiv = document.createElement('div');
                    playerWordsDiv.className = 'mb-2';
                    playerWordsDiv.innerHTML = `<strong class="font-semibold">${pName}:</strong> `;
                    if (words.length > 0) {
                        words.forEach((word, index) => {
                            const wordSpan = document.createElement('span');
                            wordSpan.className = 'cursor-pointer text-blue-600 hover:underline';
                            wordSpan.textContent = word;
                            wordSpan.onclick = () => showDefinition(word);
                            playerWordsDiv.appendChild(wordSpan);
                            if (index < words.length - 1) {
                                playerWordsDiv.append(', ');
                            }
                        });
                    } else {
                        playerWordsDiv.append('None');
                    }
                    wordView.appendChild(playerWordsDiv);
                }
            }));
            bringToFront(el.standingsModal);
            el.standingsModal.classList.remove('hidden');
        }

        function handleKeyDown(event) {
            if (gameData?.status !== 'playing' || document.activeElement === el.joinGameIdInput) return;
            if (event.key === 'Enter') { event.preventDefault(); el.submitWordBtn.click(); } 
            else if (event.key === 'Backspace') { event.preventDefault(); el.clearWordBtn.click(); } 
            else if (/^[a-zA-Z]$/.test(event.key)) {
                event.preventDefault(); const letter = event.key.toUpperCase(); const grid = JSON.parse(gameData.grid); const size = gameData.gridSize;
                const isSelected = (r, c) => currentWord.some(d => d.row === r && d.col === c);
                for (let r = 0; r < size; r++) { let foundDie = false; for (let c = 0; c < size; c++) { if (grid[r][c] === letter && !isSelected(r,c)) { const dieEl = document.querySelector(`.die[data-row='${r}'][data-col='${c}']`); handleDieClick(dieEl, grid[r][c], r, c); foundDie = true; break; }} if (foundDie) break;}
            }
        }
        
        function bringToFront(modal) {
            highestZ++;
            modal.style.zIndex = highestZ;
        }

        function setupModal(modal) {
            const header = modal.querySelector('.modal-header');
            const resizeHandle = modal.querySelector('.resize-handle');
            
            modal.addEventListener('mousedown', () => bringToFront(modal));
            
            if (header) makeDraggable(modal, header);
            if (resizeHandle) makeResizable(modal, resizeHandle);
        }

        function makeDraggable(element, header) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            header.onmousedown = dragMouseDown;

            function dragMouseDown(e) {
                e = e || window.event;
                e.preventDefault();
                pos3 = e.clientX;
                pos4 = e.clientY;
                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
            }

            function elementDrag(e) {
                e = e || window.event;
                e.preventDefault();
                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;
                element.style.top = (element.offsetTop - pos2) + "px";
                element.style.left = (element.offsetLeft - pos1) + "px";
            }

            function closeDragElement() {
                document.onmouseup = null;
                document.onmousemove = null;
            }
        }

        function makeResizable(element, handle) {
            let initialWidth, initialHeight, initialX, initialY;

            handle.onmousedown = startResize;

            function startResize(e) {
                e.preventDefault();
                initialWidth = element.offsetWidth;
                initialHeight = element.offsetHeight;
                initialX = e.clientX;
                initialY = e.clientY;
                document.onmousemove = resizeElement;
                document.onmouseup = stopResize;
            }

            function resizeElement(e) {
                const newWidth = initialWidth + (e.clientX - initialX);
                const newHeight = initialHeight + (e.clientY - initialY);
                element.style.width = newWidth + 'px';
                element.style.height = newHeight + 'px';
            }

            function stopResize() {
                document.onmousemove = null;
                document.onmouseup = null;
            }
        }

        function clearCurrentWord() { currentWord = []; renderCurrentWord(); document.querySelectorAll('.die.selected').forEach(el => el.classList.remove('selected')); }
        function formatTime(seconds) { const mins = Math.floor(seconds / 60); const secs = seconds % 60; return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`; }
        function handleCopyGameId(id) { const input = document.createElement('textarea'); input.value = id; document.body.appendChild(input); input.select(); try { document.execCommand('copy'); alert('Game ID copied!'); } catch (err) { alert('Failed to copy.'); } document.body.removeChild(input); }
        function listenForPlayerWords() {
            if (!gameData || !gameData.players) return;
            const playerIds = Object.keys(gameData.players);
            Object.keys(wordsUnsubscribe).forEach(pid => { if (!playerIds.includes(pid)) { wordsUnsubscribe[pid](); delete wordsUnsubscribe[pid]; }});
            playerIds.forEach(pid => { if (!wordsUnsubscribe[pid]) { const wordsRef = doc(db, `artifacts/${appId}/public/data/games/${gameId}/playerWords`, pid); wordsUnsubscribe[pid] = onSnapshot(wordsRef, (doc) => { playerWords[pid] = doc.data() || {}; if (pid === userId) renderMyWords(); });}});
        }
    </script>
</body>
</html>
